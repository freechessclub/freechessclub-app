name: Release Electron

on:
  push:
    branches:
      - master
    paths:
      - package.json
  workflow_dispatch:
    inputs:
      force:
        description: "Run release even without version change"
        required: false
        default: "true"

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.version.outputs.changed }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check version bump
        id: version
        shell: bash
        run: |
          set -euo pipefail
          before="${{ github.event.before }}"

          current_version=$(node -p "require('./package.json').version")

          if git cat-file -e "${before}:package.json" 2>/dev/null; then
            previous_version=$(git show "${before}:package.json" | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8')).version")
          else
            previous_version=""
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          elif [[ "$current_version" != "$previous_version" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

          echo "version=$current_version" >> "$GITHUB_OUTPUT"

  build:
    needs: check-version
    if: needs.check-version.outputs.changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Install deps
        run: yarn install --immutable

      - name: Bundle app
        run: yarn webpack --config electron.webpack.js

      - name: Build and publish (macOS)
        if: runner.os == 'macOS'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn electron-builder -m --x64 --arm64 -p always

      - name: Build and publish (Windows)
        if: runner.os == 'Windows'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn electron-builder -w --x64 -p always

      - name: Build and publish (Linux)
        if: runner.os == 'Linux'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn electron-builder -l --x64 -p always
